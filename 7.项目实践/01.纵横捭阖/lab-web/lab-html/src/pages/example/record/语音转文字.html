<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpeechRecognition è¯­éŸ³è½¬æ–‡å­—å®Œæ•´å®ç°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 800px;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4a6ee0 0%, #6a11cb 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .subtitle {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .main-content {
      padding: 40px;
    }

    .demo-area {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .btn {
      padding: 15px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #95a5a6;
    }

    .status-dot.recording {
      background: #e74c3c;
      animation: pulse 1.5s infinite;
    }

    .status-dot.listening {
      background: #2ecc71;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .status-text {
      font-size: 16px;
      color: #2c3e50;
    }

    .language-selector {
      margin-bottom: 20px;
    }

    .language-selector label {
      display: block;
      margin-bottom: 8px;
      color: #34495e;
      font-weight: 600;
    }

    .language-selector select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 16px;
      color: #2c3e50;
      background: white;
      cursor: pointer;
    }

    .transcript-area {
      margin-bottom: 30px;
    }

    .transcript-container {
      background: white;
      border: 2px solid #e0e6ed;
      border-radius: 10px;
      padding: 20px;
      min-height: 200px;
      max-height: 300px;
      overflow-y: auto;
    }

    .transcript-text {
      font-size: 18px;
      line-height: 1.6;
      color: #2c3e50;
    }

    .transcript-text .interim {
      color: #7f8c8d;
      opacity: 0.7;
    }

    .transcript-text .final {
      color: #2c3e50;
    }

    .visualizer {
      width: 100%;
      height: 100px;
      background: #2c3e50;
      border-radius: 10px;
      margin: 20px 0;
      position: relative;
      overflow: hidden;
    }

    .visualizer-bar {
      position: absolute;
      bottom: 0;
      width: 4px;
      background: #3498db;
      border-radius: 2px 2px 0 0;
    }

    .info-section {
      margin-top: 30px;
      padding: 20px;
      background: #e8f4fd;
      border-radius: 10px;
    }

    .info-section h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .info-item {
      padding: 15px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #3498db;
    }

    .info-item h4 {
      color: #3498db;
      margin-bottom: 5px;
    }

    .recordings {
      margin-top: 20px;
    }

    .recordings h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .recordings-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .recording-item {
      padding: 10px 15px;
      background: white;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #2ecc71;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .recording-item:hover {
      transform: translateX(5px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .recording-time {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 5px;
    }

    .code-block {
      background: #1a1a1a;
      color: #f8f8f2;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.5;
      overflow-x: auto;
      margin: 20px 0;
    }

    .keyword {
      color: #f92672;
    }

    .function {
      color: #66d9ef;
    }

    .string {
      color: #a6e22e;
    }

    .comment {
      color: #75715e;
    }

    .number {
      color: #ae81ff;
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
      font-size: 14px;
      border-top: 1px solid #eee;
    }

    @media (max-width: 768px) {
      .control-panel {
        grid-template-columns: 1fr;
      }

      .header {
        padding: 20px;
      }

      h1 {
        font-size: 1.8rem;
      }

      .main-content {
        padding: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤ SpeechRecognition è¯­éŸ³è½¬æ–‡å­—</h1>
      <p class="subtitle">ä½¿ç”¨ JavaScript Web Speech API å®ç°å®æ—¶è¯­éŸ³è¯†åˆ«</p>
    </div>

    <div class="main-content">
      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="control-panel">
        <button id="startBtn" class="btn btn-primary">
          <span>ğŸ¤ å¼€å§‹å½•éŸ³</span>
        </button>
        <button id="stopBtn" class="btn btn-danger" disabled>
          <span>â¹ï¸ åœæ­¢å½•éŸ³</span>
        </button>
        <button id="pauseBtn" class="btn btn-warning" disabled>
          <span>â¸ï¸ æš‚åœ</span>
        </button>
        <button id="clearBtn" class="btn">
          <span>ğŸ—‘ï¸ æ¸…ç©º</span>
        </button>
      </div>

      <!-- çŠ¶æ€æŒ‡ç¤º -->
      <div class="status-indicator">
        <div id="statusDot" class="status-dot"></div>
        <div id="statusText" class="status-text">å‡†å¤‡å°±ç»ª</div>
      </div>

      <!-- è¯­è¨€é€‰æ‹© -->
      <div class="language-selector">
        <label for="languageSelect">é€‰æ‹©è¯†åˆ«è¯­è¨€ï¼š</label>
        <select id="languageSelect">
          <option value="zh-CN">ä¸­æ–‡ (æ™®é€šè¯)</option>
          <option value="zh-TW">ä¸­æ–‡ (å°æ¹¾)</option>
          <option value="zh-HK">ä¸­æ–‡ (é¦™æ¸¯)</option>
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="ja-JP">æ—¥æœ¬èª</option>
          <option value="ko-KR">í•œêµ­ì–´</option>
          <option value="fr-FR">FranÃ§ais</option>
          <option value="de-DE">Deutsch</option>
          <option value="es-ES">EspaÃ±ol</option>
        </select>
      </div>

      <!-- è½¬å½•ç»“æœæ˜¾ç¤º -->
      <div class="transcript-area">
        <h3>è½¬å½•ç»“æœï¼š</h3>
        <div class="transcript-container">
          <div id="transcriptText" class="transcript-text">
            <!-- è½¬å½•æ–‡æœ¬å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          </div>
        </div>
      </div>

      <!-- éŸ³é¢‘å¯è§†åŒ– -->
      <div class="visualizer" id="visualizer">
        <div id="volumeLevel" style="position: absolute; top: 10px; left: 10px; color: white; font-size: 12px;">
          éŸ³é‡: 0%
        </div>
      </div>

      <!-- å½•éŸ³è®°å½• -->
      <div class="recordings">
        <h3>ğŸ“ å†å²è®°å½•</h3>
        <div id="recordingsList" class="recordings-list">
          <!-- å†å²è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
      </div>

      <!-- ä¿¡æ¯åŒºåŸŸ -->
      <div class="info-section">
        <h3>ğŸ” ä½¿ç”¨è¯´æ˜</h3>
        <div class="info-grid">
          <div class="info-item">
            <h4>æ”¯æŒæƒ…å†µ</h4>
            <p>éœ€è¦ HTTPS ç¯å¢ƒï¼ŒChrome å’Œ Edge æ”¯æŒæœ€ä½³</p>
          </div>
          <div class="info-item">
            <h4>éº¦å…‹é£æƒé™</h4>
            <p>é¦–æ¬¡ä½¿ç”¨éœ€è¦å…è®¸éº¦å…‹é£è®¿é—®</p>
          </div>
          <div class="info-item">
            <h4>å®æ—¶è½¬å½•</h4>
            <p>ç°è‰²æ–‡å­—ä¸ºä¸´æ—¶ç»“æœï¼Œé»‘è‰²æ–‡å­—ä¸ºæœ€ç»ˆç»“æœ</p>
          </div>
        </div>
      </div>

      <!-- ä»£ç ç¤ºä¾‹ -->
      <div class="code-block">
        <pre><span class="keyword">class</span> <span class="function">SpeechToText</span> {
  <span class="function">constructor</span>() {
    <span class="keyword">this</span>.recognition = null;
    <span class="keyword">this</span>.isListening = <span class="keyword">false</span>;
    <span class="keyword">this</span>.transcript = <span class="string">''</span>;
    
    <span class="comment">// åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«</span>
    <span class="keyword">this</span>.<span class="function">initRecognition</span>();
  }
  
  <span class="function">initRecognition</span>() {
    <span class="keyword">const</span> SpeechRecognition = window.SpeechRecognition || 
                            window.webkitSpeechRecognition;
    
    <span class="keyword">if</span> (!SpeechRecognition) {
      <span class="keyword">throw new</span> <span class="function">Error</span>(<span class="string">'æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«'</span>);
    }
    
    <span class="keyword">this</span>.recognition = <span class="keyword">new</span> <span class="function">SpeechRecognition</span>();
    
    <span class="comment">// é…ç½®è¯†åˆ«å™¨</span>
    <span class="keyword">this</span>.recognition.continuous = <span class="keyword">true</span>;
    <span class="keyword">this</span>.recognition.interimResults = <span class="keyword">true</span>;
    <span class="keyword">this</span>.recognition.lang = <span class="string">'zh-CN'</span>;
    
    <span class="comment">// ç»‘å®šäº‹ä»¶å¤„ç†</span>
    <span class="keyword">this</span>.recognition.onresult = (event) => {
      <span class="keyword">this</span>.<span class="function">handleResult</span>(event);
    };
  }
}</pre>
      </div>
    </div>

    <div class="footer">
      <p>åŸºäº Web Speech API å®ç° | æ”¯æŒ Chromeã€Edge ç­‰ç°ä»£æµè§ˆå™¨</p>
    </div>
  </div>

  <script>
    class SpeechToText {
      constructor() {
        this.recognition = null;
        this.isListening = false;
        this.isPaused = false;
        this.finalTranscript = '';
        this.interimTranscript = '';
        this.audioContext = null;
        this.analyser = null;
        this.records = JSON.parse(localStorage.getItem('speechRecords')) || [];
        this.init();
      }

      init() {
        this.initRecognition();
        this.initVisualizer();
        this.bindEvents();
        this.renderRecords();
        this.updateStatus('å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»å¼€å§‹æŒ‰é’®å¼€å§‹è¯­éŸ³è¯†åˆ«', 'ready');
      }

      initRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRecognition) {
          this.updateStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½', 'error');
          document.getElementById('startBtn').disabled = true;
          return;
        }

        this.recognition = new SpeechRecognition();
        this.configureRecognition();
        this.bindRecognitionEvents();
      }

      configureRecognition() {
        const language = document.getElementById('languageSelect').value;

        // åŸºæœ¬é…ç½®
        this.recognition.continuous = true;        // æŒç»­è¯†åˆ«
        this.recognition.interimResults = true;   // è¿”å›ä¸­é—´ç»“æœ
        this.recognition.lang = language;         // è®¾ç½®è¯­è¨€
        this.recognition.maxAlternatives = 3;     // è¿”å›å¤šä¸ªå€™é€‰ç»“æœ

        // é«˜çº§é…ç½®ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
        if (this.recognition.grammars) {
          // å¯ä»¥è®¾ç½®è¯­æ³•
        }
      }

      bindRecognitionEvents() {
        this.recognition.onstart = () => {
          this.isListening = true;
          this.isPaused = false;
          this.updateStatus('æ­£åœ¨ç›‘å¬ä¸­...', 'listening');
          this.updateButtons();
        };

        this.recognition.onresult = (event) => {
          this.handleRecognitionResult(event);
        };

        this.recognition.onerror = (event) => {
          this.handleRecognitionError(event);
        };

        this.recognition.onend = () => {
          this.isListening = false;
          this.updateStatus('è¯†åˆ«å·²åœæ­¢', 'ready');
          this.updateButtons();
        };

        this.recognition.onaudiostart = () => {
          console.log('éŸ³é¢‘è¾“å…¥å¼€å§‹');
        };

        this.recognition.onaudioend = () => {
          console.log('éŸ³é¢‘è¾“å…¥ç»“æŸ');
        };

        this.recognition.onsoundstart = () => {
          console.log('æ£€æµ‹åˆ°å£°éŸ³');
        };

        this.recognition.onsoundend = () => {
          console.log('å£°éŸ³ç»“æŸ');
        };

        this.recognition.onspeechstart = () => {
          console.log('æ£€æµ‹åˆ°è¯­éŸ³å¼€å§‹');
        };

        this.recognition.onspeechend = () => {
          console.log('è¯­éŸ³ç»“æŸ');
        };

        this.recognition.onnomatch = () => {
          console.log('æ²¡æœ‰åŒ¹é…çš„è¯†åˆ«ç»“æœ');
        };
      }

      handleRecognitionResult(event) {
        this.interimTranscript = '';
        this.finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const transcript = event.results[i][0].transcript;

          if (event.results[i].isFinal) {
            // æœ€ç»ˆç»“æœ
            this.finalTranscript += transcript;
            this.saveToRecords(transcript);
          } else {
            // ä¸´æ—¶ç»“æœ
            this.interimTranscript += transcript;
          }
        }

        this.updateTranscript();
      }

      updateTranscript() {
        const transcriptEl = document.getElementById('transcriptText');
        let html = '';

        if (this.finalTranscript) {
          html += `<div class="final">${this.finalTranscript}</div>`;
        }

        if (this.interimTranscript) {
          html += `<div class="interim">${this.interimTranscript}</div>`;
        }

        transcriptEl.innerHTML = html;

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        transcriptEl.scrollTop = transcriptEl.scrollHeight;
      }

      handleRecognitionError(event) {
        let errorMessage = 'è¯†åˆ«é”™è¯¯: ';

        switch (event.error) {
          case 'not-allowed':
          case 'permission-denied':
            errorMessage += 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·å…è®¸è®¿é—®éº¦å…‹é£';
            break;
          case 'audio-capture':
            errorMessage += 'æ— æ³•æ•è·éŸ³é¢‘ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£';
            break;
          case 'no-speech':
            errorMessage += 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³';
            break;
          case 'network':
            errorMessage += 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
            break;
          case 'service-not-allowed':
            errorMessage += 'è¯­éŸ³è¯†åˆ«æœåŠ¡ä¸å¯ç”¨';
            break;
          case 'language-not-supported':
            errorMessage += 'ä¸æ”¯æŒæ‰€é€‰è¯­è¨€';
            break;
          default:
            errorMessage += event.error;
        }

        this.updateStatus(errorMessage, 'error');
        console.error('SpeechRecognition error:', event);

        // å¦‚æœé”™è¯¯ä¸æ˜¯ç”±ç”¨æˆ·åœæ­¢å¼•èµ·çš„ï¼Œå°è¯•é‡å¯
        if (event.error !== 'aborted' && this.isListening) {
          setTimeout(() => {
            if (this.isListening) {
              this.start();
            }
          }, 1000);
        }
      }

      async start() {
        if (!this.recognition) {
          this.updateStatus('è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨', 'error');
          return;
        }

        if (this.isListening) {
          this.updateStatus('å·²ç»åœ¨è¯†åˆ«ä¸­', 'warning');
          return;
        }

        try {
          // æ£€æŸ¥éº¦å…‹é£æƒé™
          const stream = await navigator.mediaDevices.getUserMedia({
            // audio: {
            //   echoCancellation: true,
            //   noiseSuppression: true,
            //   autoGainControl: true
            // }
            audio: true
          });

          // // åœæ­¢æµä»¥é˜²æ­¢å¤šä¸ªæµåŒæ—¶è¿è¡Œ
          // stream.getTracks().forEach(track => track.stop());

          // è®¾ç½®è¯­è¨€
          this.recognition.lang = document.getElementById('languageSelect').value;

          // å¼€å§‹è¯†åˆ«
          this.recognition.start();

          // å¼€å§‹éŸ³é¢‘å¯è§†åŒ–
          this.startVisualization();

        } catch (error) {
          this.handlePermissionError(error);
        }
      }

      handlePermissionError(error) {
        let errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£: ';

        if (error.name === 'NotAllowedError') {
          errorMessage += 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®';
        } else if (error.name === 'NotFoundError') {
          errorMessage += 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡';
        } else if (error.name === 'NotReadableError') {
          errorMessage += 'éº¦å…‹é£æ­£è¢«å…¶ä»–åº”ç”¨ä½¿ç”¨';
        } else {
          errorMessage += error.message;
        }

        this.updateStatus(errorMessage, 'error');
        console.error('éº¦å…‹é£è®¿é—®é”™è¯¯:', error);
      }

      stop() {
        if (this.recognition && this.isListening) {
          this.recognition.stop();
          this.isListening = false;
          this.updateStatus('å·²åœæ­¢', 'ready');
          this.stopVisualization();
        }
      }

      pause() {
        if (this.isListening && !this.isPaused) {
          this.isPaused = true;
          this.recognition.stop();
          this.updateStatus('å·²æš‚åœ', 'paused');
        } else if (this.isPaused) {
          this.isPaused = false;
          this.recognition.start();
          this.updateStatus('æ­£åœ¨ç›‘å¬ä¸­...', 'listening');
        }
      }

      clear() {
        this.finalTranscript = '';
        this.interimTranscript = '';
        this.updateTranscript();
        this.updateStatus('å·²æ¸…ç©º', 'ready');
      }

      saveToRecords(text) {
        if (!text.trim()) return;

        const record = {
          id: Date.now(),
          text: text,
          language: this.recognition.lang,
          timestamp: new Date().toLocaleString(),
          date: Date.now()
        };

        this.records.unshift(record);

        // é™åˆ¶ä¿å­˜æ•°é‡
        if (this.records.length > 50) {
          this.records = this.records.slice(0, 50);
        }

        this.saveRecords();
        this.renderRecords();
      }

      saveRecords() {
        localStorage.setItem('speechRecords', JSON.stringify(this.records));
      }

      renderRecords() {
        const listEl = document.getElementById('recordingsList');

        if (this.records.length === 0) {
          listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d;">æš‚æ— å†å²è®°å½•</div>';
          return;
        }

        let html = '';
        this.records.forEach(record => {
          html += `
                        <div class="recording-item" data-id="${record.id}">
                            <div>${record.text}</div>
                            <div class="recording-time">
                                ${record.timestamp} (${this.getLanguageName(record.language)})
                            </div>
                        </div>
                    `;
        });

        listEl.innerHTML = html;

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        listEl.querySelectorAll('.recording-item').forEach(item => {
          item.addEventListener('click', () => {
            const id = parseInt(item.dataset.id);
            const record = this.records.find(r => r.id === id);
            if (record) {
              this.finalTranscript = record.text;
              this.interimTranscript = '';
              this.updateTranscript();
            }
          });
        });
      }

      getLanguageName(code) {
        const languages = {
          'zh-CN': 'ä¸­æ–‡',
          'zh-TW': 'ä¸­æ–‡(ç¹ä½“)',
          'zh-HK': 'ä¸­æ–‡(é¦™æ¸¯)',
          'en-US': 'è‹±è¯­(ç¾å›½)',
          'en-GB': 'è‹±è¯­(è‹±å›½)',
          'ja-JP': 'æ—¥è¯­',
          'ko-KR': 'éŸ©è¯­',
          'fr-FR': 'æ³•è¯­',
          'de-DE': 'å¾·è¯­',
          'es-ES': 'è¥¿ç­ç‰™è¯­'
        };

        return languages[code] || code;
      }

      initVisualizer() {
        this.visualizer = document.getElementById('visualizer');
        this.volumeLevel = document.getElementById('volumeLevel');
        this.bars = [];

        // åˆ›å»ºå¯è§†åŒ–æ¡
        for (let i = 0; i < 64; i++) {
          const bar = document.createElement('div');
          bar.className = 'visualizer-bar';
          this.visualizer.appendChild(bar);
          this.bars.push(bar);
        }
      }

      async startVisualization() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          this.analyser = this.audioContext.createAnalyser();
          this.source = this.audioContext.createMediaStreamSource(stream);

          this.analyser.fftSize = 256;
          this.source.connect(this.analyser);

          this.animateVisualizer();

        } catch (error) {
          console.error('éŸ³é¢‘å¯è§†åŒ–å¤±è´¥:', error);
        }
      }

      animateVisualizer() {
        if (!this.isListening) return;

        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const draw = () => {
          if (!this.isListening) return;

          requestAnimationFrame(draw);

          this.analyser.getByteFrequencyData(dataArray);

          // è®¡ç®—å¹³å‡éŸ³é‡
          let sum = 0;
          for (let i = 0; i < bufferLength; i++) {
            sum += dataArray[i];
          }
          const average = sum / bufferLength;
          const volumePercent = Math.round((average / 255) * 100);

          // æ›´æ–°éŸ³é‡æ˜¾ç¤º
          this.volumeLevel.textContent = `éŸ³é‡: ${volumePercent}%`;

          // æ›´æ–°å¯è§†åŒ–æ¡
          const barWidth = (this.visualizer.offsetWidth - 20) / this.bars.length;

          this.bars.forEach((bar, i) => {
            const value = dataArray[i] || 0;
            const height = (value / 255) * this.visualizer.offsetHeight;

            bar.style.height = `${height}px`;
            bar.style.width = `${barWidth}px`;
            bar.style.left = `${i * barWidth}px`;

            // æ ¹æ®éŸ³é‡è®¾ç½®é¢œè‰²
            const hue = (value / 255) * 120; // ç»¿è‰²åˆ°çº¢è‰²
            bar.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;
          });
        };

        draw();
      }

      stopVisualization() {
        if (this.audioContext) {
          this.audioContext.close();
          this.audioContext = null;
        }

        // é‡ç½®å¯è§†åŒ–
        this.bars.forEach(bar => {
          bar.style.height = '0px';
        });
        this.volumeLevel.textContent = 'éŸ³é‡: 0%';
      }

      updateStatus(message, type = 'ready') {
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        statusText.textContent = message;

        // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
        statusDot.className = 'status-dot';

        // æ·»åŠ å½“å‰çŠ¶æ€ç±»
        if (type === 'listening') {
          statusDot.classList.add('listening');
        } else if (type === 'recording') {
          statusDot.classList.add('recording');
        } else if (type === 'error') {
          statusDot.style.background = '#e74c3c';
        } else if (type === 'warning') {
          statusDot.style.background = '#f39c12';
        } else {
          statusDot.style.background = '#2ecc71';
        }
      }

      updateButtons() {
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const pauseBtn = document.getElementById('pauseBtn');

        if (this.isListening) {
          startBtn.disabled = true;
          stopBtn.disabled = false;
          pauseBtn.disabled = false;
          pauseBtn.innerHTML = this.isPaused ? '<span>â–¶ï¸ ç»§ç»­</span>' : '<span>â¸ï¸ æš‚åœ</span>';
        } else {
          startBtn.disabled = false;
          stopBtn.disabled = true;
          pauseBtn.disabled = true;
        }
      }

      bindEvents() {
        // æŒ‰é’®äº‹ä»¶
        document.getElementById('startBtn').addEventListener('click', () => this.start());
        document.getElementById('stopBtn').addEventListener('click', () => this.stop());
        document.getElementById('pauseBtn').addEventListener('click', () => this.pause());
        document.getElementById('clearBtn').addEventListener('click', () => this.clear());

        // è¯­è¨€é€‰æ‹©å˜åŒ–
        document.getElementById('languageSelect').addEventListener('change', () => {
          if (this.isListening) {
            this.stop();
            setTimeout(() => {
              this.start();
            }, 300);
          }
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
          if (document.hidden && this.isListening) {
            this.stop();
          }
        });
      }
    }

    // åˆå§‹åŒ–åº”ç”¨
    let speechToText = null;

    document.addEventListener('DOMContentLoaded', () => {
      try {
        speechToText = new SpeechToText();
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        document.getElementById('statusText').textContent = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message;
      }
    });

    // å¯¼å‡ºä¸ºå…¨å±€å˜é‡ä»¥ä¾¿è°ƒè¯•
    window.speechToText = speechToText;
  </script>
</body>

</html>